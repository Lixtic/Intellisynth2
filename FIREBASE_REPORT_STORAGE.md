# Firebase Report Storage Implementation

## Overview
Reports generated by the AI Flight Recorder are now persistently stored in Firebase Firestore. This allows reports to:
- Survive server restarts
- Be accessed historically
- Be shared across different sessions
- Support advanced querying and filtering

## Architecture

### Service Layer
**File:** `app/services/report_service_firestore.py`

The `ReportServiceFirestore` class provides full CRUD operations for reports:

```python
class ReportServiceFirestore:
    def __init__(self):
        # Lazy initialization to avoid early Firebase connection
        self.db = None
        self.collection = None
        self._initialized = False
    
    async def create_report(self, report_data: dict) -> dict
    async def get_report(self, report_id: str) -> Optional[dict]
    async def list_reports(self, report_type: str = None, status: str = None, limit: int = 50, offset: int = 0) -> List[dict]
    async def get_reports_summary(self) -> dict
    async def delete_report(self, report_id: str) -> bool
    async def delete_old_reports(self, days: int = 90) -> int
```

### Data Model

Each report stored in Firestore has the following structure:

```json
{
  "id": "report-1763308693",
  "type": "agent_activity|security_summary|compliance_check|performance_metrics",
  "time_period": "24h|7d|30d",
  "status": "completed|pending|failed",
  "generated_at": "2025-11-16T15:58:13.803612+00:00",
  "data": {
    // Report-specific data structure
    "total_activities": 100,
    "agent_stats": {...},
    "activity_metrics": {...}
  },
  "metadata": {
    "data_size": 149,
    "record_count": 100,
    "generator": "ai_flight_recorder",
    "version": "1.0.0"
  }
}
```

### Firestore Collection

**Collection Name:** `reports`  
**Configured in:** `app/firebase_config.py`

```python
class Collections:
    AGENTS = "agents"
    ACTIVITY_LOGS = "activity_logs"
    REPORTS = "reports"  # New collection for report storage
```

## API Endpoints

All report endpoints now use Firebase for persistence:

### 1. Get Reports Summary
```http
GET /api/reports/summary
```

**Response:**
```json
{
  "total_reports": 6,
  "reports_24h": 6,
  "successful_24h": 6,
  "available_types": ["agent_activity", "security_summary", "compliance_check", "performance_metrics"]
}
```

### 2. List Reports
```http
GET /api/reports?type=agent_activity&status=completed&limit=50&offset=0
```

**Query Parameters:**
- `type` (optional): Filter by report type
- `status` (optional): Filter by status
- `limit` (optional): Number of results (default: 50)
- `offset` (optional): Pagination offset (default: 0)

**Response:**
```json
{
  "status": "success",
  "total": 6,
  "reports": [
    {
      "id": "report-1763308693",
      "type": "agent_activity",
      "time_period": "24h",
      "status": "completed",
      "generated_at": "2025-11-16T15:58:13.803612+00:00",
      "metadata": {
        "data_size": 149,
        "record_count": 100,
        "generator": "ai_flight_recorder"
      }
    }
  ]
}
```

### 3. Generate Report
```http
POST /api/reports/generate
Content-Type: application/json

{
  "type": "agent_activity",
  "time_period": "24h"
}
```

**Supported Report Types:**
- `agent_activity`: Activity statistics by agent
- `security_summary`: Security events and alerts
- `compliance_check`: Compliance status report
- `performance_metrics`: System performance data

**Time Periods:**
- `24h`: Last 24 hours
- `7d`: Last 7 days
- `30d`: Last 30 days

**Response:**
```json
{
  "status": "success",
  "report": {
    "id": "report-1763308693",
    "type": "agent_activity",
    "time_period": "24h",
    "status": "completed",
    "generated_at": "2025-11-16T15:58:13.803612+00:00",
    "data": {
      "total_activities": 100,
      "agent_stats": {...},
      "activity_metrics": {...}
    }
  }
}
```

### 4. Get Specific Report
```http
GET /api/reports/{report_id}
```

**Response:**
```json
{
  "id": "report-1763308693",
  "type": "agent_activity",
  "time_period": "24h",
  "status": "completed",
  "generated_at": "2025-11-16T15:58:13.803612+00:00",
  "data": {
    // Full report data
  },
  "metadata": {
    "data_size": 149,
    "record_count": 100,
    "generator": "ai_flight_recorder",
    "version": "1.0.0"
  }
}
```

## Implementation Details

### Lazy Initialization
The service uses lazy initialization to avoid Firebase connection issues during module import:

```python
async def _ensure_initialized(self):
    if self._initialized:
        return
    
    if not firebase_config.is_initialized():
        raise RuntimeError("Firebase not initialized. Call initialize() first.")
    
    self.db = firebase_config.get_db()
    self.collection = self.db.collection(Collections.REPORTS)
    self._initialized = True
```

### Metadata Tracking
Each report includes metadata for management:
- `data_size`: Size of report data in bytes
- `record_count`: Number of records in report
- `generator`: System that generated the report
- `version`: Report schema version

### Date/Time Handling
Firestore timestamps are properly handled with timezone awareness:

```python
# When comparing dates
if generated_at.replace(tzinfo=None) > cutoff_24h:
    reports_24h += 1
```

### Factory Pattern
The `get_report_service()` function in `app/config.py` always returns the Firebase service:

```python
def get_report_service() -> ReportServiceFirestore:
    """
    Get the report service (always Firebase for cloud persistence).
    Reports are always stored in Firebase for persistence and sharing.
    """
    return report_service_firestore
```

## Testing

### Automated Tests
**File:** `test_firebase_reports.py`

Comprehensive test suite covering:
- ✅ Report creation (3 different types)
- ✅ Individual report retrieval
- ✅ List all reports
- ✅ Filter by type (requires Firestore index)
- ✅ Summary statistics
- ✅ Metadata verification

### Manual API Testing

Using curl or Postman:

```powershell
# Generate report
curl -X POST http://127.0.0.1:8000/api/reports/generate `
  -H "Content-Type: application/json" `
  -d '{"type": "agent_activity", "time_period": "24h"}'

# List reports
curl http://127.0.0.1:8000/api/reports

# Get summary
curl http://127.0.0.1:8000/api/reports/summary

# Get specific report
curl http://127.0.0.1:8000/api/reports/report-1763308693
```

## Known Limitations

### Firestore Index Required for Filtering
Filtering reports by type requires a Firestore composite index. You'll see this warning:

```
The query requires an index. You can create it here: https://console.firebase.google.com/...
```

**Solution:** Click the provided URL to create the index in Firebase Console. This is a one-time setup.

### Required Index Configuration
Create a composite index on the `reports` collection:
- Field: `type` (Ascending)
- Field: `generated_at` (Descending)

## Benefits

1. **Persistence**: Reports survive server restarts
2. **Scalability**: Cloud storage handles growing report archives
3. **Accessibility**: Reports accessible from any instance
4. **Real-time**: Firestore enables real-time report updates
5. **Queryable**: Advanced filtering and search capabilities
6. **Metadata**: Rich metadata for report management
7. **Backup**: Automatic Firebase backup and replication

## Migration Notes

### Previous Behavior
- Reports were generated on-demand and returned in-memory
- No persistence - reports lost on server restart
- Activity logs were queried directly for historical data

### New Behavior
- Reports are generated AND stored in Firestore
- Historical reports are accessible via API
- Reports have unique IDs for retrieval
- Metadata tracked for each report

### Backwards Compatibility
The API endpoints maintain the same request/response structure, with additions:
- Response includes `id` field for report retrieval
- Response includes `metadata` field with storage info
- New query parameters for filtering

## Future Enhancements

Potential improvements:
- [ ] Report export (PDF, Excel, CSV)
- [ ] Scheduled report generation
- [ ] Report sharing with permissions
- [ ] Automated cleanup policies
- [ ] Report templates
- [ ] Custom report types
- [ ] Email delivery of reports
- [ ] Report comparison tools

## Configuration

### Environment Variables
```bash
FIREBASE_CREDENTIALS=./intellisynth-c1050-firebase-adminsdk-fbsvc-61edd8337e.json
STORAGE_BACKEND=firebase  # Use Firebase for all storage
```

### Service Selection
Reports always use Firebase (configured in `app/config.py`):

```python
# Reports always use Firebase for persistence
def get_report_service():
    return report_service_firestore
```

## Troubleshooting

### Firebase Not Initialized
**Error:** "Firebase not initialized. Call initialize() first."

**Solution:** Ensure Firebase is initialized before creating reports:
```python
from app.firebase_config import firebase_config
firebase_config.initialize(credentials_path)
```

### Index Missing
**Error:** "The query requires an index."

**Solution:** Click the provided URL to create the index in Firebase Console.

### Timezone Issues
**Error:** Date comparisons failing

**Solution:** Firestore timestamps are timezone-aware. Use `.replace(tzinfo=None)` when comparing:
```python
generated_at.replace(tzinfo=None) > cutoff_date
```

## Success Metrics

From test results:
- ✅ 6 reports successfully stored in Firestore
- ✅ All CRUD operations working
- ✅ Summary statistics accurate (100% success rate)
- ✅ Metadata properly tracked
- ✅ Real-time persistence confirmed

## Conclusion

Firebase report storage is fully implemented and tested. All reports are now persisted in Firestore with comprehensive metadata, enabling historical access, querying, and future enhancements like scheduled generation and sharing.
